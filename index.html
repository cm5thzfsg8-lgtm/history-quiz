<!DOCTYPE html>
<html lang="ko">
<head>
    <link rel="manifest" href="manifest.json">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë¼ì§€ìŒ¤ë„¤ í•™êµ í•œêµ­ì‚¬</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        :root { --primary: #FF9800; --dark: #3E2723; --bg: #fdf6e3; --white: #ffffff; --error: #F44336; --success: #4CAF50; --note: #9C27B0; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: var(--bg); font-family: 'Pretendard', sans-serif; overflow: hidden; }
        .app-container { width: 95%; max-width: 400px; margin: 3vh auto; height: 94vh; background: var(--white); border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); display: flex; flex-direction: column; overflow: hidden; }
        .header { background: var(--primary); color: white; padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; }
        .content { flex: 1; padding: 15px; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .hidden { display: none !important; }
        button { width: 100%; padding: 12px; border: none; border-radius: 10px; font-size: 0.95rem; font-weight: 600; cursor: pointer; margin-bottom: 8px; }
        .btn-main { background: var(--primary); color: white; box-shadow: 0 3px 0 #e68a00; }
        .btn-note { background: var(--note); color: white; box-shadow: 0 3px 0 #7B1FA2; }
        .btn-choice { background: #ffffff; border: 1.5px solid #eee; text-align: left; color: var(--dark); padding: 12px; }
        .score-board { background: #fff3e0; border: 2px dashed var(--primary); border-radius: 15px; padding: 15px; text-align: center; margin-bottom: 15px; }
        .wrong-item { background: #f3e5f5; border-radius: 10px; padding: 12px; margin-bottom: 10px; border-left: 5px solid var(--note); font-size: 0.9rem; }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <h2 style="margin:0; font-size:1rem;">ğŸ· ë¼ì§€ìŒ¤ë„¤ í•œêµ­ì‚¬</h2>
            <button onclick="renderMain()" style="width:auto; padding:4px 10px; font-size:0.75rem; background:rgba(255,255,255,0.2); border:1px solid white; color:white;">ğŸ  ì²˜ìŒìœ¼ë¡œ</button>
        </div>

        <div class="content">
            <div id="screen-main" class="hidden">
                <div class="score-board">
                    <div style="font-size:1.2rem; font-weight:800;">í˜„ì¬ ì ìˆ˜: <span id="display-score">0</span>ì </div>
                </div>
                <button class="btn-note" id="note-btn" onclick="renderNote()">ğŸ“– ì˜¤ë‹µ ë…¸íŠ¸ í™•ì¸ (<span id="wrong-count">0</span>)</button>
                <div id="category-buttons" style="margin-top:15px;"></div>
            </div>

            <div id="screen-quiz" class="hidden">
                <div id="question-text" style="font-weight:700; margin-bottom:15px; font-size:1.05rem;"></div>
                <div id="choice-container"></div>
                <div id="explanation-area" class="hidden">
                    <div id="explanation-text" style="background:#e3f2fd; padding:15px; border-radius:10px; margin-bottom:10px; font-size:0.88rem;"></div>
                    <button class="btn-main" onclick="showQuestion()">ë‹¤ìŒ ë¬¸ì œ â¡ï¸</button>
                </div>
            </div>

            <div id="screen-note" class="hidden">
                <h3 style="color:var(--note);">ğŸ“– ë‚˜ì˜ ì˜¤ë‹µ ëª©ë¡</h3>
                <p style="font-size:0.8rem; color:#666; margin-bottom:15px;">í‹€ë¦° ë¬¸ì œë“¤ì„ ë‹¤ì‹œ ë³µìŠµí•´ë³´ì„¸ìš”.</p>
                <div id="note-list"></div>
                <button class="btn-main" style="background:#666; box-shadow:0 3px 0 #444;" onclick="clearNote()">ì˜¤ë‹µ ê¸°ë¡ ì „ì²´ ì‚­ì œ</button>
            </div>
        </div>
    </div>

    <script>
        const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS85FYgWxBD0qHWTc1gX7dlUItO8p-MFoTOGtXXFtQjrg3cySjigK10C2ATzNUASrPNTfMt-0nQ9jju/pub?output=csv";
        let allData = {}, currentQuestions = [], currentIndex = 0, score = 0;
        let wrongQuestions = JSON.parse(localStorage.getItem('wrongDB') || "[]"); // í°ì— ì €ì¥ëœ ì˜¤ë‹µ ë¶ˆëŸ¬ì˜¤ê¸°

        function loadData() {
            Papa.parse(SHEET_URL, {
                download: true, header: true, complete: function(results) {
                    results.data.forEach(row => {
                        const cat = row['ì‹œëŒ€']?.trim(); if (!cat) return;
                        if (!allData[cat]) allData[cat] = [];
                        allData[cat].push({ q: row['ì§ˆë¬¸'], a: [row['ë³´ê¸°1'], row['ë³´ê¸°2'], row['ë³´ê¸°3'], row['ë³´ê¸°4']], c: row['ì •ë‹µë²ˆí˜¸']?.trim(), ex: row['í•´ì„¤'] });
                    });
                    renderMain();
                }
            });
        }

        function renderMain() {
            document.querySelectorAll('.content > div').forEach(div => div.classList.add('hidden'));
            document.getElementById('screen-main').classList.remove('hidden');
            document.getElementById('display-score').innerText = score;
            document.getElementById('wrong-count').innerText = wrongQuestions.length;
            
            const container = document.getElementById('category-buttons');
            container.innerHTML = "";
            Object.keys(allData).forEach(cat => {
                const btn = document.createElement('button');
                btn.className = "btn-main";
                btn.innerText = cat;
                btn.onclick = () => startQuiz(cat);
                container.appendChild(btn);
            });
        }

        function startQuiz(cat) {
            currentQuestions = [...allData[cat]].sort(() => Math.random() - 0.5);
            currentIndex = 0;
            document.getElementById('screen-main').classList.add('hidden');
            document.getElementById('screen-quiz').classList.remove('hidden');
            showQuestion();
        }

        function showQuestion() {
            if (currentIndex >= currentQuestions.length) { alert("í•œ ë°”í€´ ë‹¤ ëŒì•˜ìŠµë‹ˆë‹¤!"); renderMain(); return; }
            const qObj = currentQuestions[currentIndex];
            document.getElementById('explanation-area').classList.add('hidden');
            document.getElementById('question-text').innerText = "Q. " + qObj.q;
            const container = document.getElementById('choice-container');
            container.innerHTML = "";
            qObj.a.forEach(choice => {
                if(!choice) return;
                const btn = document.createElement('button');
                btn.className = "btn-choice"; btn.innerText = choice;
                btn.onclick = () => checkAnswer(btn, choice, qObj);
                container.appendChild(btn);
            });
        }

        function checkAnswer(btn, selected, qObj) {
            const btns = document.querySelectorAll('.btn-choice');
            btns.forEach(b => b.disabled = true);
            const isCorrect = selected.trim() === qObj.c.trim();

            if (isCorrect) {
                btn.style.background = "#c8e6c9"; score += 10;
            } else {
                btn.style.background = "#ffcdd2"; score = Math.max(0, score - 5);
                // ì˜¤ë‹µ ì €ì¥ (ì¤‘ë³µ ì²´í¬)
                if (!wrongQuestions.find(i => i.q === qObj.q)) {
                    wrongQuestions.push(qObj);
                    localStorage.setItem('wrongDB', JSON.stringify(wrongQuestions));
                }
                btns.forEach(b => { if(b.innerText.trim() === qObj.c.trim()) b.style.border = "2px solid var(--success)"; });
            }
            document.getElementById('explanation-text').innerText = "ğŸ’¡ í•´ì„¤: " + qObj.ex;
            document.getElementById('explanation-area').classList.remove('hidden');
            currentIndex++;
        }

        function renderNote() {
            document.querySelectorAll('.content > div').forEach(div => div.classList.add('hidden'));
            document.getElementById('screen-note').classList.remove('hidden');
            const list = document.getElementById('note-list');
            list.innerHTML = wrongQuestions.length === 0 ? "<p>ì•„ì§ í‹€ë¦° ë¬¸ì œê°€ ì—†ì–´ìš”!</p>" : "";
            wrongQuestions.forEach((q, idx) => {
                const item = document.createElement('div');
                item.className = "wrong-item";
                item.innerHTML = `<strong>Q. ${q.q}</strong><br><span style="color:var(--success)">ì •ë‹µ: ${q.c}</span><br><small style="color:#666">${q.ex}</small>`;
                list.appendChild(item);
            });
        }

        function clearNote() {
            if(confirm("ì˜¤ë‹µ ê¸°ë¡ì„ ëª¨ë‘ ì§€ìš¸ê¹Œìš”?")) {
                wrongQuestions = []; localStorage.removeItem('wrongDB'); renderMain();
            }
        }

        loadData();
    </script>
</body>
</html>
